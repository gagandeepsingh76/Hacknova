<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Microcontroller Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --bg-color: #020617; 
            --card-color: rgba(15, 23, 42, 0.7);
            --border-color: #1e293b; 
            --text-light: #e2e8f0;
            --accent-color: #f97316; /* Orange */
        }
        body { background-color: var(--bg-color); color: var(--text-light); font-family: 'Inter', sans-serif; }
        .glass-card { background: var(--card-color); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid var(--border-color); }
        .sim-button {
            background: var(--accent-color); color: var(--bg-color);
            transition: all .2s ease; box-shadow: 0 4px 10px rgba(0,0,0,.3);
        }
        .sim-button:hover { background: #fb923c; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,.4); }
        #code-editor { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        #serial-monitor { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-amber-400">Microcontroller Simulator</h1>
            <p class="mt-2 text-slate-400 max-w-2xl mx-auto">Write and run Arduino-style code to control a virtual board with an LED, button, and sensor.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="glass-card shadow-2xl p-2 rounded-2xl lg:col-span-2">
                <canvas id="simulation-canvas" class="w-full h-[500px] md:h-[600px] rounded-lg"></canvas>
            </div>
            
            <div class="space-y-6">
                 <h2 class="text-2xl font-bold text-center text-slate-300">Code & Monitor</h2>
                <div class="glass-card shadow-lg p-5 rounded-2xl space-y-4">
                    <h3 class="font-bold text-lg text-orange-300 flex items-center">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        Code Editor
                    </h3>
                    <div class="bg-slate-900/50 rounded-lg border border-slate-700 h-64 p-2">
                        <textarea id="code-editor" class="w-full h-full bg-transparent text-slate-200 outline-none resize-none" spellcheck="false">const int ledPin = 13;
const int buttonPin = 2;
const int sensorPin = A0;

void setup() {
  Serial.begin(9600);
  pinMode(ledPin, OUTPUT);
  pinMode(buttonPin, INPUT);
}

void loop() {
  int buttonState = digitalRead(buttonPin);
  
  if (buttonState == HIGH) {
    digitalWrite(ledPin, HIGH);
  } else {
    digitalWrite(ledPin, LOW);
  }
  
  int sensorValue = analogRead(sensorPin);
  Serial.println(sensorValue);
  
  delay(100);
}</textarea>
                    </div>
                </div>

                <div class="glass-card shadow-lg p-5 rounded-2xl space-y-4">
                     <h3 class="font-bold text-lg text-orange-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect><line x1="2" y1="12" x2="22" y2="12"></line></svg>
                        Serial Monitor
                    </h3>
                    <div id="serial-monitor" class="w-full h-32 bg-slate-900/50 rounded-lg border border-slate-700 p-2 text-xs text-green-400 overflow-y-auto"></div>
                    <div class="flex gap-4 pt-2">
                        <button id="upload-btn" class="w-full sim-button font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            Upload & Run
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
(function() {
    const canvas = document.getElementById('simulation-canvas');
    const ctx = canvas.getContext('2d');
    const codeEditor = document.getElementById('code-editor');
    const serialMonitor = document.getElementById('serial-monitor');
    const uploadBtn = document.getElementById('upload-btn');

    let simState = {
        running: false,
        pins: Array(20).fill(null).map(() => ({ mode: 'INPUT', value: 0 })),
        analogPins: Array(6).fill(null).map(() => ({ value: 0 })),
        components: {
            button: { pin: 2, pressed: false },
            potentiometer: { pin: 0, value: 512 }
        },
        stopExecution: false,
    };

    function resizeCanvas() {
        const simRect = canvas.parentElement.getBoundingClientRect();
        canvas.width = simRect.width;
        canvas.height = simRect.height > 100 ? simRect.height : 600;
        draw();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBoard();
        drawComponents();
    }

    function drawBoard() {
        const boardX = canvas.width / 2 - 150, boardY = 50, boardW = 300, boardH = 450;
        ctx.fillStyle = '#22d3ee';
        ctx.fillRect(boardX, boardY, boardW, boardH);
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(boardX + 10, boardY + 10, boardW - 20, boardH - 20);

        // On-board LED
        ctx.fillStyle = simState.pins[13].value === 1 ? '#f97316' : '#475569';
        ctx.beginPath();
        ctx.arc(boardX + 100, boardY + 100, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '10px Inter';
        ctx.fillText('L', boardX + 98, boardY + 120);
    }
    
    function drawComponents() {
        // Button
        const btnX = 50, btnY = 100;
        ctx.fillStyle = simState.components.button.pressed ? '#fb923c' : '#f97316';
        ctx.fillRect(btnX, btnY, 50, 50);
        ctx.strokeStyle = '#e2e8f0';
        ctx.strokeRect(btnX, btnY, 50, 50);
        ctx.fillText('Button (Pin 2)', btnX + 25, btnY + 70);
        
        // Potentiometer
        const potX = 50, potY = 200;
        ctx.fillStyle = '#475569';
        ctx.fillRect(potX, potY, 50, 150);
        const potSliderY = potY + 150 - (simState.components.potentiometer.value / 1023) * 150;
        ctx.fillStyle = '#f97316';
        ctx.fillRect(potX-5, potSliderY-5, 60, 10);
        ctx.fillText(`Sensor (A0): ${simState.components.potentiometer.value}`, potX + 25, potY + 170);
    }

    async function runCode() {
        if (simState.running) {
            simState.stopExecution = true;
            await new Promise(r => setTimeout(r, 200)); // wait for loop to stop
        }
        
        serialMonitor.innerHTML = '';
        simState.stopExecution = false;
        simState.running = true;
        uploadBtn.textContent = 'Stop';
        
        // Simplified interpreter
        const code = codeEditor.value;
        const setupCode = code.substring(code.indexOf('void setup()'), code.indexOf('void loop()'));
        const loopCode = code.substring(code.indexOf('void loop()'));
        
        const interpret = new Function('pins', 'analogPins', 'serial', 'delay', 'digitalRead', 'analogRead', 'pinMode', 'digitalWrite', `
            const HIGH = 1, LOW = 0, OUTPUT='OUTPUT', INPUT='INPUT';
            return (async function() {
                try {
                    ${setupCode}
                    setup();
                    while(!this.stop) {
                       ${loopCode}
                       await loop();
                    }
                } catch(e) {
                    serial.println('Error: ' + e.message);
                }
            }).bind({stop: false})
        `);

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        const api = {
            pins: simState.pins,
            analogPins: simState.analogPins,
            serial: {
                println: (text) => {
                    serialMonitor.innerHTML += text + '<br>';
                    serialMonitor.scrollTop = serialMonitor.scrollHeight;
                }
            },
            delay: async (ms) => { await sleep(ms); },
            digitalRead: (pin) => simState.pins[pin].value,
            analogRead: (pin) => simState.analogPins[pin].value,
            pinMode: (pin, mode) => { simState.pins[pin].mode = mode; },
            digitalWrite: (pin, value) => { simState.pins[pin].value = value; },
        };
        
        const runner = interpret(api.pins, api.analogPins, api.serial, api.delay, api.digitalRead, api.analogRead, api.pinMode, api.digitalWrite);
        
        const executionPromise = runner();
        executionPromise.finally(() => {
            simState.running = false;
            uploadBtn.textContent = 'Upload & Run';
        });

        // Visual update loop
        function renderLoop() {
            if (simState.stopExecution) {
                executionPromise.self.stop = true;
                return;
            }
            draw();
            requestAnimationFrame(renderLoop);
        }
        renderLoop();
    }
    
    function stopCode() {
        simState.stopExecution = true;
        simState.running = false;
        uploadBtn.textContent = 'Upload & Run';
    }

    // --- Event Handlers ---
    uploadBtn.addEventListener('click', () => {
        if (simState.running) {
            stopCode();
        } else {
            runCode();
        }
    });

    canvas.addEventListener('mousedown', e => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        if(x > 50 && x < 100 && y > 100 && y < 150) {
            simState.components.button.pressed = true;
            simState.pins[simState.components.button.pin].value = 1;
        }
    });
     canvas.addEventListener('mouseup', () => {
        simState.components.button.pressed = false;
        simState.pins[simState.components.button.pin].value = 0;
    });

    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const potY = 200, potH = 150;
        if(e.buttons === 1 && y >= potY && y <= potY + potH) {
            const value = 1023 - ((y - potY) / potH) * 1023;
            simState.components.potentiometer.value = Math.round(Math.max(0, Math.min(1023, value)));
            simState.analogPins[simState.components.potentiometer.pin].value = simState.components.potentiometer.value;
        }
    });

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
})();
</script>
</body>
</html>

